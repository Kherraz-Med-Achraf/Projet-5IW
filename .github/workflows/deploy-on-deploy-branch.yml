name: Simple Deploy on Deploy Branch

on:
  push:
    branches: [deploy]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸš€ Deploy to production
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.MGR_HOST }}
          username: ${{ secrets.MGR_SSH_USER }}
          key: ${{ secrets.MGR_SSH_KEY }}
          port: ${{ secrets.MGR_SSH_PORT || 22 }}
          command_timeout: 30m
          script: |
            set -euo pipefail

            echo "ðŸ“‚ AccÃ¨s au rÃ©pertoire du projet..."
            cd /home/github/projet5iw

            echo "ðŸ”„ Mise Ã  jour du code depuis la branche deploy..."
            # Utiliser le token GitHub stockÃ©
            git pull https://${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git deploy

            echo "ðŸ” VÃ©rification de l'Ã©tat du Swarm..."
            docker node ls

            echo "ðŸ—ï¸ Lancement du processus de build et dÃ©ploiement..."
            chmod +x ./build-deploy.sh
            ./build-deploy.sh

            echo "âœ… VÃ©rification du dÃ©ploiement..."
            sleep 10
            docker stack services projet5iw

            echo "ðŸŽ‰ DÃ©ploiement terminÃ© avec succÃ¨s !"

      - name: ðŸ“Š Summary
        if: always()
        run: |
          echo "## ðŸ“ˆ DÃ©ploiement" >> $GITHUB_STEP_SUMMARY
          echo "- **Statut**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: https://educareschool.me" >> $GITHUB_STEP_SUMMARY
