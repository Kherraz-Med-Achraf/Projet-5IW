datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

/*──────────────────────────────  USER  ──────────────────────────────*/
model User {
  id                  String                @id @default(cuid())
  email               String                @unique
  emailVerified       Boolean               @default(false)
  password            String
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt()
  otpSecret           String?
  passwordResets      PasswordReset[]
  emailVerifications  EmailVerification[]
  refreshToken        String?
  role                Role                  @default(USER)
  passwordChangedAt   DateTime              @default(now())
  forcePasswordReset  Boolean               @default(false)
  failedLoginAttempts Int                   @default(0)
  lockUntil           DateTime?

  /** relations **/
  parentProfile         ParentProfile?
  childProfile          Child?           @relation(name: "ChildToUser")
  secretaryProfile      SecretaryProfile?
  directorProfile       DirectorProfile?
  serviceManagerProfile ServiceManagerProfile?
}

/*─────────────────────────  PASSWORD RESET  ─────────────────────────*/
model PasswordReset {
  id        Int      @id @default(autoincrement())
  token     String
  expiresAt DateTime
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  createdAt DateTime @default(now())
}

/*───────────────────────  EMAIL VERIFICATION  ───────────────────────*/
model EmailVerification {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  expiresAt DateTime
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  createdAt DateTime @default(now())
}

/*──────────────────────────────  ROLES  ─────────────────────────────*/
enum Role {
  USER
  ADMIN
  TEACHER
  CHILD
  PARENT
  SECRETARY
  DIRECTOR
  SERVICE_MANAGER
}

/*────────────────────────  PARENT PROFILE  ─────────────────────────*/
model ParentProfile {
  id                  Int               @id @default(autoincrement())
  user                User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId              String            @unique

  firstName           String
  lastName            String
  phone               String
  address             String
  legalResponsibility String
  notificationPrefs   Json              @default("{}")

  emergencyContacts   EmergencyContact[]
  children            Child[]

  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt()
}

/*──────────────────────────────  CHILD  ────────────────────────────*/
model Child {
  id               Int             @id @default(autoincrement())
  firstName        String
  lastName         String
  birthDate        DateTime
  condition        String?

  parent           ParentProfile   @relation(fields: [parentProfileId], references: [id], onDelete: Cascade)
  parentProfileId  Int

  user             User?           @relation(name: "ChildToUser", fields: [userId], references: [id], onDelete: Cascade)
  userId           String?         @unique
}

/*───────────────────────  EMERGENCY CONTACT  ───────────────────────*/
model EmergencyContact {
  id               Int             @id @default(autoincrement())
  name             String
  relation         String
  phone            String
  parent           ParentProfile   @relation(fields: [parentProfileId], references: [id], onDelete: Cascade)
  parentProfileId  Int
}

/*──────────────────────── SECRETARY PROFILE ─────────────────────────*/
model SecretaryProfile {
  id           Int      @id @default(autoincrement())
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId       String   @unique
  jobTitle     String
  startDate    DateTime
  profileImage String?
  firstName    String
  lastName     String
  birthDate    DateTime
  phone        String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @default(now()) @updatedAt()

}

/*──────────────────────── DIRECTOR PROFILE ─────────────────────────*/
model DirectorProfile {
  id           Int      @id @default(autoincrement())
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId       String   @unique
  jobTitle     String
  startDate    DateTime
  profileImage String?
  firstName    String
  lastName     String
  birthDate    DateTime
  phone        String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @default(now()) @updatedAt()
}

/*─────────────────── SERVICE MANAGER PROFILE ───────────────────────*/
model ServiceManagerProfile {
  id           Int      @id @default(autoincrement())
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId       String   @unique
  jobTitle     String
  startDate    DateTime
  profileImage String?
  firstName    String
  lastName     String
  birthDate    DateTime
  phone        String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @default(now()) @updatedAt()
}
