#!/bin/bash

echo "üîß CORRECTION SENDGRID SECRET - PRODUCTION"
echo "=========================================="
echo ""

echo "üìã DIAGNOSTIC PRODUCTION:"
echo "========================="
echo ""
echo "1Ô∏è‚É£ CONNEXION AU SERVEUR:"
echo "ssh root@educareschool.me"
echo ""

echo "2Ô∏è‚É£ V√âRIFICATION DU SECRET:"
echo "cd /home/github/projet5iw/projet5iw-deploy"
echo "docker secret ls | grep sendgrid"
echo ""

echo "3Ô∏è‚É£ SI LE SECRET N'EXISTE PAS:"
echo "echo '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' | docker secret create sendgrid_api_key -"
echo ""

echo "4Ô∏è‚É£ V√âRIFICATION DU SECRET CR√â√â:"
echo "docker secret ls | grep sendgrid"
echo ""

echo "5Ô∏è‚É£ RED√âPLOIEMENT DU SERVICE:"
echo "git pull origin deploy"
echo "docker stack deploy -c docker-compose.swarm.yml projet5iw-deploy"
echo ""

echo "6Ô∏è‚É£ V√âRIFICATION DES LOGS:"
echo "docker service logs projet5iw-deploy_backend --tail 20"
echo ""

echo "üîç DIAGNOSTIC AVANC√â:"
echo "===================="
echo ""
echo "Si le secret existe mais ne marche pas:"
echo "1. V√©rifier qu'il est bien mont√© dans le container:"
echo "   docker exec -it \$(docker ps -q -f name=projet5iw-deploy_backend) ls -la /run/secrets/"
echo ""
echo "2. V√©rifier le contenu du secret:"
echo "   docker exec -it \$(docker ps -q -f name=projet5iw-deploy_backend) cat /run/secrets/sendgrid_api_key"
echo ""
echo "3. V√©rifier les variables d'environnement:"
echo "   docker exec -it \$(docker ps -q -f name=projet5iw-deploy_backend) env | grep SENDGRID"
echo ""

echo "üí° SOLUTION ALTERNATIVE:"
echo "========================"
echo "Si le secret Docker ne fonctionne pas, utiliser une variable d'environnement:"
echo ""
echo "Dans docker-compose.swarm.yml, remplacer:"
echo "   - SENDGRID_API_KEY_FILE=/run/secrets/sendgrid_api_key"
echo "Par:"
echo "   - SENDGRID_API_KEY=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"
echo ""
echo "Et supprimer 'sendgrid_api_key' des secrets du service."
echo ""

echo "üéØ R√âSOLUTION GARANTIE:"
echo "======================"
echo "1. Le secret Docker n'existe pas ‚Üí Le cr√©er"
echo "2. Le secret existe mais n'est pas accessible ‚Üí V√©rifier les permissions"
echo "3. En dernier recours ‚Üí Utiliser une variable d'environnement"
echo ""

echo "‚ö†Ô∏è  RAPPEL:"
echo "==========="
echo "La cl√© SendGrid est:"
echo "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"
echo ""
echo "Elle fonctionne parfaitement en local, donc le probl√®me"
echo "est uniquement dans la configuration Docker en production."
echo "" 