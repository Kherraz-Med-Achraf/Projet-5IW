name: Deploy on deploy branch

# DÃ©clenche uniquement sur push vers la branche deploy
on:
  push:
    branches: [deploy]
  pull_request:
    branches: [deploy]
    types: [closed]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    # Ne s'exÃ©cute que si c'est un push direct ou un PR mergÃ©
    if: github.event_name == 'push' || (github.event.pull_request.merged == true)

    steps:
      - name: ğŸ Start deployment
        run: |
          echo "ğŸš€ DÃ©but du dÃ©ploiement automatique"
          echo "ğŸ“ Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Auteur: ${{ github.actor }}"

      - name: ğŸ“¡ SSH to manager & deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.MGR_HOST }}
          username: ${{ secrets.MGR_SSH_USER }}
          key: ${{ secrets.MGR_SSH_KEY }}
          port: ${{ secrets.MGR_SSH_PORT || 22 }}
          script: |
            set -euo pipefail
            
            echo "ğŸ“‚ AccÃ¨s au rÃ©pertoire du projet..."
            cd /home/github/projet5iw
            
            echo "ğŸ”„ Mise Ã  jour du code depuis la branche deploy..."
            git fetch origin
            git checkout deploy
            git reset --hard origin/deploy
            
            echo "ğŸ” VÃ©rification de l'Ã©tat du Swarm..."
            docker node ls
            
            echo "ğŸ—ï¸ Lancement du processus de build et dÃ©ploiement..."
            chmod +x ./build-deploy.sh
            ./build-deploy.sh
            
            echo "âœ… VÃ©rification du dÃ©ploiement..."
            sleep 10
            docker stack services projet5iw
            
            echo "ğŸ‰ DÃ©ploiement terminÃ© avec succÃ¨s !"

      - name: ğŸ“Š Deployment Summary
        if: always()
        run: |
          echo "## ğŸ“ˆ RÃ©sumÃ© du DÃ©ploiement" >> $GITHUB_STEP_SUMMARY
          echo "- **Branche**: deploy" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Auteur**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Statut**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: https://educareschool.me" >> $GITHUB_STEP_SUMMARY

  notify-success:
    runs-on: ubuntu-latest
    needs: build-and-deploy
    if: success()
    steps:
      - name: ğŸ‰ Success notification
        run: |
          echo "âœ… DÃ©ploiement rÃ©ussi !"
          echo "ğŸŒ Application disponible sur: https://educareschool.me"
          echo "ğŸ“Š Monitoring: https://kuma.educareschool.me"

  notify-failure:
    runs-on: ubuntu-latest
    needs: build-and-deploy
    if: failure()
    steps:
      - name: âŒ Failure notification
        run: |
          echo "âŒ Ã‰chec du dÃ©ploiement"
          echo "ğŸ” VÃ©rifiez les logs ci-dessus pour plus de dÃ©tails"
