import { Test, TestingModule } from '@nestjs/testing';
import { INestApplication } from '@nestjs/common';
import * as request from 'supertest';
import { CoursModule } from '../src/cours/cours.module';
import { CoursService } from '../src/cours/cours.service';
import { PrismaService } from '../src/prisma/prisma.service';
import { JwtAuthGuard } from '../src/common/guards/jwt-auth.guard';
import { RolesGuard } from '../src/common/guards/roles.guard';
import { CsrfGuard } from '../src/common/guards/csrf.guard';
import { ValidationPipe } from '@nestjs/common';

describe('Cours E2E - Simulation Enfant fait le Cours de Fran√ßais', () => {
  let app: INestApplication;
  let coursService: CoursService;
  
  const childId = 1;
  const childName = 'Lucas';

  // Storage pour simuler la persistance
  let progressStorage: any = {
    childId: childId,
    matiere: 'francais',
    currentStep: 'introduction',
    progressPercent: 0,
    data: {},
    completedAt: null,
  };

  // Mock simple pour PrismaService
  const mockPrisma = {
    child: {
      findUnique: jest.fn().mockResolvedValue({
        id: childId,
        firstName: childName,
        lastName: 'Martin',
      }),
    },
  };

  // Mock du CoursService avec persistance simul√©e
  const mockCoursService = {
    getMatieres: jest.fn().mockResolvedValue([
      { id: 'francais', title: 'Fran√ßais', description: 'Lecture, √©criture et expression', available: true },
      { id: 'math', title: 'Math√©matiques', description: 'Nombres, calculs et logique', available: true },
      { id: 'communication', title: 'Communication', description: 'Pictogrammes et expression', available: true },
    ]),
    
    getMatiere: jest.fn().mockImplementation((matiereId, childId) => {
      if (matiereId === 'francais') {
        return Promise.resolve({
          id: 'francais',
          title: 'Fran√ßais',
          description: 'Lecture, √©criture et expression',
          estimatedDuration: 8,
          steps: ['introduction', 'regle', 'exercices', 'production', 'verification', 'synthese'],
        });
      }
      return Promise.resolve(null);
    }),
    
    getProgress: jest.fn().mockImplementation(() => {
      return Promise.resolve({ ...progressStorage });
    }),
    
    saveProgress: jest.fn().mockImplementation((data) => {
      progressStorage = { ...progressStorage, ...data };
      return Promise.resolve(progressStorage);
    }),
    
    updateProgress: jest.fn().mockImplementation((childId, matiere, data) => {
      progressStorage = { ...progressStorage, ...data };
      return Promise.resolve(progressStorage);
    }),
    
    completeCours: jest.fn().mockImplementation((childId, matiere) => {
      progressStorage = {
        ...progressStorage,
        childId,
        matiere,
        currentStep: 'synthese',
        progressPercent: 100,
        completedAt: new Date(),
      };
      return Promise.resolve(progressStorage);
    }),
    
    getChildStats: jest.fn().mockResolvedValue({
      totalCours: 3,
      coursCompleted: 1,
      averageProgress: 100,
      lastActivity: new Date(),
    }),
  };

  // Mock simple pour les Guards (pas d'auth)
  const mockAuthGuard = {
    canActivate: jest.fn().mockReturnValue(true),
  };

  const mockRolesGuard = {
    canActivate: jest.fn().mockReturnValue(true),
  };

  const mockCsrfGuard = {
    canActivate: jest.fn().mockReturnValue(true),
  };

  beforeAll(async () => {
    const moduleFixture: TestingModule = await Test.createTestingModule({
      imports: [CoursModule],
    })
      .overrideProvider(PrismaService)
      .useValue(mockPrisma)
      .overrideProvider(CoursService)
      .useValue(mockCoursService)
      .overrideGuard(JwtAuthGuard)
      .useValue(mockAuthGuard)
      .overrideGuard(RolesGuard)
      .useValue(mockRolesGuard)
      .overrideGuard(CsrfGuard)
      .useValue(mockCsrfGuard)
      .compile();

    app = moduleFixture.createNestApplication();
    
    app.useGlobalPipes(new ValidationPipe({
      whitelist: true,
      forbidNonWhitelisted: false,
      transform: true,
      disableErrorMessages: false,
      validateCustomDecorators: true,
    }));
    
    coursService = moduleFixture.get<CoursService>(CoursService);
    await app.init();
  });

  afterAll(async () => {
    await app.close();
  });

  describe('üéì Lucas fait le Cours de Fran√ßais - Accord du participe pass√©', () => {
    let currentProgress: any = null;

    it('üìö √âtape 1: Lucas d√©couvre les mati√®res disponibles', async () => {
      console.log(`\nüßí ${childName} se connecte et regarde ses cours disponibles...`);
      
      const response = await request(app.getHttpServer())
        .get(`/cours/child/${childId}/matieres`)
        .expect(200);

      expect(response.body).toHaveLength(3);
      
      const francais = response.body.find((m: any) => m.id === 'francais');
      expect(francais).toMatchObject({
        id: 'francais',
        title: 'Fran√ßais',
        description: 'Lecture, √©criture et expression',
        available: true,
      });

      console.log('‚úÖ Lucas voit ses 3 mati√®res : Fran√ßais, Maths, Communication');
      console.log(`üéØ Il choisit le Fran√ßais : "${francais.description}"`);
    });

    it('üìñ √âtape 2: Lucas consulte les d√©tails du cours de Fran√ßais', async () => {
      console.log(`\nüìñ ${childName} ouvre le cours de Fran√ßais...`);
      
      const response = await request(app.getHttpServer())
        .get(`/cours/child/${childId}/matiere/francais`)
        .expect(200);

      expect(response.body).toMatchObject({
        id: 'francais',
        title: 'Fran√ßais',
        description: 'Lecture, √©criture et expression',
        estimatedDuration: 8,
        steps: ['introduction', 'regle', 'exercices', 'production', 'verification', 'synthese'],
      });

      console.log(`üìã Cours: "${response.body.title}" - ${response.body.estimatedDuration} minutes`);
      console.log(`üìù Sujet: Accord du participe pass√© avec "avoir"`);
      console.log(`üî¢ ${response.body.steps.length} √©tapes √† suivre`);
    });

    it('üé¨ √âtape 3: Lucas commence - Introduction', async () => {
      console.log(`\nüé¨ ${childName} commence l'introduction...`);
      
      // V√©rifier la progression initiale
      const initialResponse = await request(app.getHttpServer())
        .get(`/cours/child/${childId}/progress/francais`)
        .expect(200);

      expect(initialResponse.body).toMatchObject({
        childId: childId,
        matiere: 'francais',
        currentStep: 'introduction',
        progressPercent: 0,
      });

      // Lucas progresse dans l'introduction
      const progressData = {
        childId: childId,
        matiere: 'francais',
        currentStep: 'introduction',
        progressPercent: 16, // 1/6 √©tapes
        data: { 
          watchedIntro: true,
          exampleSeen: 'Les lettres que j\'ai lues',
          understood: true 
        },
      };

      const saveResponse = await request(app.getHttpServer())
        .post('/cours/progress')
        .send(progressData)
        .expect(201);

      currentProgress = saveResponse.body;
      
      console.log('üéØ Introduction termin√©e !');
      console.log('üìö Exemple vu: "Les lettres que j\'ai lues"');
      console.log(`üìä Progression: ${currentProgress.progressPercent}%`);
    });

    it('üìè √âtape 4: Lucas apprend la r√®gle', async () => {
      console.log(`\nüìè ${childName} apprend la r√®gle d'accord...`);
      
      const progressData = {
        childId: childId,
        matiere: 'francais',
        currentStep: 'regle',
        progressPercent: 33, // 2/6 √©tapes
        data: { 
          ruleUnderstood: true,
          codSteps: ['identifier le verbe', 'rep√©rer le COD', 'v√©rifier sa position'],
          examples: ['j\'ai cueilli la fleur', 'la fleur que j\'ai cueillie'],
          mastered: true
        },
      };

      const response = await request(app.getHttpServer())
        .post('/cours/progress')
        .send(progressData)
        .expect(201);

      currentProgress = response.body;
      
      console.log('üìã R√®gle apprise:');
      console.log('   1Ô∏è‚É£ Identifier le verbe avec "avoir"');
      console.log('   2Ô∏è‚É£ Rep√©rer le COD');
      console.log('   3Ô∏è‚É£ V√©rifier si le COD est AVANT le verbe');
      console.log('   ‚úÖ Si OUI ‚Üí on accorde, si NON ‚Üí on n\'accorde pas');
      console.log(`üìä Progression: ${currentProgress.progressPercent}%`);
    });

    it('üéØ √âtape 5: Lucas fait les exercices', async () => {
      console.log(`\nüéØ ${childName} fait les exercices pratiques...`);
      
      const progressData = {
        childId: childId,
        matiere: 'francais',
        currentStep: 'exercices',
        progressPercent: 50, // 3/6 √©tapes
        data: { 
          quiz1: { 
            question: 'Les pommes que j\'ai ___ (manger)',
            answer: 'mang√©es',
            correct: true,
            explanation: 'COD "les pommes" avant le verbe ‚Üí accord'
          },
          quiz2: {
            question: 'Les devoirs que nous avons ___ (faire)',
            answer: 'faits',
            correct: true,
            explanation: 'COD "les devoirs" avant le verbe ‚Üí accord'
          },
          score: 10 // sur 10
        },
      };

      const response = await request(app.getHttpServer())
        .post('/cours/progress')
        .send(progressData)
        .expect(201);

      currentProgress = response.body;
      
      console.log('üéØ Exercices termin√©s !');
      console.log('‚úÖ Quiz 1: "Les pommes que j\'ai mang√©es" - CORRECT');
      console.log('‚úÖ Quiz 2: "Les devoirs que nous avons faits" - CORRECT');
      console.log(`üèÜ Score: ${progressData.data.score}/10 - Excellent !`);
      console.log(`üìä Progression: ${currentProgress.progressPercent}%`);
    });

    it('‚úçÔ∏è √âtape 6: Lucas produit ses propres phrases', async () => {
      console.log(`\n‚úçÔ∏è ${childName} cr√©e ses propres phrases...`);
      
      const progressData = {
        childId: childId,
        matiere: 'francais',
        currentStep: 'production',
        progressPercent: 66, // 4/6 √©tapes
        data: { 
          createdSentences: [
            'Les histoires que j\'ai lues √©taient passionnantes.',
            'La voiture que papa a achet√©e est rouge.',
            'Les fleurs que maman a cueillies sentent bon.'
          ],
          validated: true,
          creativity: 'excellent'
        },
      };

      const response = await request(app.getHttpServer())
        .post('/cours/progress')
        .send(progressData)
        .expect(201);

      currentProgress = response.body;
      
      console.log('‚úçÔ∏è Phrases cr√©√©es par Lucas:');
      progressData.data.createdSentences.forEach((phrase: string, index: number) => {
        console.log(`   ${index + 1}. "${phrase}"`);
      });
      console.log('üåü Cr√©ativit√©: Excellente !');
      console.log(`üìä Progression: ${currentProgress.progressPercent}%`);
    });

    it('üîç √âtape 7: Lucas v√©rifie ses connaissances', async () => {
      console.log(`\nüîç ${childName} fait la v√©rification finale...`);
      
      const progressData = {
        childId: childId,
        matiere: 'francais',
        currentStep: 'verification',
        progressPercent: 83, // 5/6 √©tapes
        data: { 
          finalTest: {
            questions: 5,
            correct: 5,
            details: [
              'Les livres que j\'ai lus ‚úÖ',
              'La lettre que j\'ai √©crite ‚úÖ', 
              'Les amis que j\'ai vus ‚úÖ',
              'La chanson que j\'ai chant√©e ‚úÖ',
              'Les photos que j\'ai prises ‚úÖ'
            ]
          },
          mastery: 'parfait'
        },
      };

      const response = await request(app.getHttpServer())
        .post('/cours/progress')
        .send(progressData)
        .expect(201);

      currentProgress = response.body;
      
      console.log('üîç Test de v√©rification:');
      console.log(`‚úÖ ${progressData.data.finalTest.correct}/${progressData.data.finalTest.questions} bonnes r√©ponses`);
      console.log('üéØ Ma√Ætrise: Parfaite !');
      console.log(`üìä Progression: ${currentProgress.progressPercent}%`);
    });

    it('üéâ √âtape 8: Lucas termine le cours avec succ√®s', async () => {
      console.log(`\nüéâ ${childName} termine le cours de Fran√ßais !`);
      
      // Completion du cours
      const completionResponse = await request(app.getHttpServer())
        .post(`/cours/child/${childId}/complete/francais`)
        .expect(201);

      expect(completionResponse.body).toMatchObject({
        childId: childId,
        matiere: 'francais',
        currentStep: 'synthese',
        progressPercent: 100,
      });
      expect(completionResponse.body.completedAt).toBeDefined();

      // V√©rifier les stats finales
      const statsResponse = await request(app.getHttpServer())
        .get(`/cours/child/${childId}/stats`)
        .expect(200);

      console.log('üèÜ COURS TERMIN√â AVEC SUCC√àS !');
      console.log('üìú Certificat: Accord du participe pass√© ma√Ætris√©');
      console.log(`‚è∞ Temps total: ~8 minutes`);
      console.log(`üìä Progression finale: ${completionResponse.body.progressPercent}%`);
      console.log(`üìÖ Date de completion: ${new Date(completionResponse.body.completedAt).toLocaleString()}`);
      console.log(`üìà Cours disponibles: ${statsResponse.body.totalCours}`);
      
      // Message de f√©licitation
      console.log(`\nüéä F√©licitations ${childName} !`);
      console.log('Tu ma√Ætrises maintenant l\'accord du participe pass√© avec "avoir" !');
      console.log('üöÄ Tu peux maintenant passer aux cours de Maths ou Communication !');
    });

    it('üìä V√©rification finale: Le parcours est bien enregistr√©', async () => {
      console.log(`\nüìä V√©rification du parcours de ${childName}...`);
      
      const finalProgress = await request(app.getHttpServer())
        .get(`/cours/child/${childId}/progress/francais`)
        .expect(200);

      const finalStats = await request(app.getHttpServer())
        .get(`/cours/child/${childId}/stats`)
        .expect(200);

      expect(finalProgress.body.progressPercent).toBe(100);
      expect(finalProgress.body.completedAt).toBeDefined();
      expect(finalStats.body.totalCours).toBe(3);
      
      console.log('‚úÖ Progression sauvegard√©e correctement');
      console.log('‚úÖ Statistiques mises √† jour');
      console.log('‚úÖ Certificat de r√©ussite g√©n√©r√©');
      console.log('\nüéì Mission accomplie ! Lucas a r√©ussi son cours de Fran√ßais ! üéì');
    });
  });
});