#!/bin/bash

echo "ğŸ¯ DIAGNOSTIC FINAL + SOLUTION GARANTIE"
echo "======================================="
echo "âœ… Code local vÃ©rifiÃ© - TOUT EST CORRECT !"
echo "âœ… Configuration Docker - PARFAITE !"
echo "âœ… MailService - UNIFIÃ‰ ET FONCTIONNEL !"
echo ""

echo "ğŸ”§ PROBLÃˆME = PRODUCTION NON SYNCHRONISÃ‰E"
echo "========================================="
echo "Le problÃ¨me est forcÃ©ment sur le serveur :"
echo "â€¢ Secret 'sendgrid_api_key' manquant"
echo "â€¢ OU service pas redÃ©ployÃ© avec derniÃ¨res modifs"
echo ""

echo "ğŸ“ CONNEXION AU SERVEUR :"
echo "ssh root@educareschool.me"
echo ""

echo "ğŸ“ NAVIGATION :"
echo "cd /home/github/projet5iw/projet5iw-deploy"
echo ""

echo "ğŸ” Ã‰TAPE 1 - VÃ‰RIFICATION SECRET :"
echo "docker secret ls | grep sendgrid"
echo ""
echo "SI AUCUN RÃ‰SULTAT â†’ CrÃ©er le secret :"
echo "echo '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' | docker secret create sendgrid_api_key -"
echo ""

echo "ğŸš€ Ã‰TAPE 2 - REDÃ‰PLOIEMENT FORCÃ‰ :"
echo "# ArrÃªter le service"
echo "docker-compose -f docker-compose.swarm.yml down nest"
echo ""
echo "# Build sans cache"
echo "docker-compose -f docker-compose.swarm.yml build nest --no-cache"
echo ""
echo "# DÃ©marrage"
echo "docker-compose -f docker-compose.swarm.yml up -d nest"
echo ""

echo "ğŸ“Š Ã‰TAPE 3 - VÃ‰RIFICATION IMMÃ‰DIATE :"
echo "docker-compose -f docker-compose.swarm.yml logs nest | tail -30"
echo ""

echo "ğŸ¯ LOGS ATTENDUS (SUCCÃˆS) :"
echo "ğŸ“§ SENDGRID CONFIGURATION FOUND:"
echo "   API Key: âœ… Configured"
echo ""

echo "ğŸ§ª Ã‰TAPE 4 - TEST INVITATION :"
echo "â€¢ Interface admin â†’ CrÃ©er invitation"
echo "â€¢ VÃ©rifier email reÃ§u dans boÃ®te"
echo ""

echo "ğŸ† RÃ‰SOLUTION 100% GARANTIE !"
echo "=============================="
echo "AprÃ¨s ce processus :"
echo "â†’ SendGrid fonctionne (si secret OK)"
echo "â†’ Erreur claire (si secret manquant)"
echo "â†’ JAMAIS plus d'ETIMEDOUT Gmail !"
echo ""

echo "ğŸš€ PRÃŠT POUR DÃ‰PLOIEMENT !" 